{% extends "base.html" %}

{% block title %}Cost Analysis - AI-Horizon{% endblock %}

{% block extra_styles %}
<style>


        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .cost-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .cost-item {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .cost-label {
            font-size: 0.875rem;
            color: #718096;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .cost-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
        }

        .budget-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .budget-input label {
            font-weight: 600;
            color: #4a5568;
        }

        .budget-input input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            width: 120px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #4299e1;
            color: white;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #3182ce);
            transition: width 0.3s ease;
        }

        .budget-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .scenario-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #4299e1;
        }

        .scenario-budget {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .scenario-details {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 5px;
        }

        .api-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .api-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #9f7aea;
        }

        .api-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .api-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }

        .api-stat-label {
            color: #718096;
        }

        .api-stat-value {
            color: #2d3748;
            font-weight: 600;
        }

        .recommendations {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .recommendations h4 {
            color: #2c7a7b;
            margin-bottom: 10px;
        }

        .recommendations ul {
            color: #2d3748;
            padding-left: 20px;
        }

        .recommendations li {
            margin-bottom: 5px;
        }

        .cost-history {
            height: 200px;
            background: #f7fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-style: italic;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .alert-warning {
            background: #fefcbf;
            color: #744210;
            border-left: 4px solid #d69e2e;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .loading {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 20px;
        }
</style>
{% endblock %}

{% block content %}
    <div class="main-content">
<!-- Navigation Header -->
        

        <div class="header">
            <h1>üí∞ Cost Analysis & Budget Management</h1>
            <p>Monitor API spending, analyze budget efficiency, and optimize collection costs</p>
        </div>

        <!-- Budget Controls -->
        <div class="card">
            <h3>Budget Configuration</h3>
            <div class="budget-input">
                <label for="monthlyBudget">Monthly Budget ($):</label>
                <input type="number" id="monthlyBudget" value="100" min="1" max="10000" step="1">
                <button class="btn" onclick="updateBudget()">Update Analysis</button>
                <button class="btn btn-danger btn-small" onclick="resetSessionCost()">Reset Session Cost</button>
            </div>
            
            <!-- Budget Status Alert -->
            <div id="budgetAlert" class="alert alert-success" style="display: none;">
                Budget analysis will appear here...
            </div>
        </div>

        <div class="dashboard">
            <!-- Current Costs Overview -->
            <div class="card">
                <h3>üíµ Current Costs</h3>
                <div class="cost-overview">
                    <div class="cost-item">
                        <div class="cost-label">Today</div>
                        <div class="cost-value" id="todayCost">$0.00</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">This Month</div>
                        <div class="cost-value" id="monthCost">$0.00</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Total Historic</div>
                        <div class="cost-value" id="totalCost">$0.00</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Session Cost</div>
                        <div class="cost-value" id="sessionCost">$0.00</div>
                    </div>
                </div>
                
                <!-- Budget Progress -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Budget Utilization</span>
                        <span id="budgetPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="budgetProgress" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #718096; margin-top: 5px;">
                        <span id="budgetRemaining">$100.00 remaining</span>
                    </div>
                </div>
            </div>

            <!-- Collection Cost Estimates -->
            <div class="card">
                <h3>üìà Collection Cost Estimates</h3>
                <div class="cost-overview">
                    <div class="cost-item">
                        <div class="cost-label">Per Article</div>
                        <div class="cost-value" id="costPerArticle">$0.003</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Full Run (80)</div>
                        <div class="cost-value" id="fullRunCost">$0.24</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Collections/Month</div>
                        <div class="cost-value" id="collectionsPerMonth">416</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Frequency</div>
                        <div class="cost-value" id="collectionFrequency">Daily</div>
                    </div>
                </div>
            </div>

            <!-- API Usage Breakdown -->
            <div class="card">
                <h3>üîå API Usage Breakdown</h3>
                <div id="apiBreakdown" class="api-breakdown">
                    <div class="loading">Loading API usage data...</div>
                </div>
            </div>

            <!-- Budget Scenarios -->
            <div class="card">
                <h3>üí∞ Budget Scenarios</h3>
                <div class="budget-scenarios" id="budgetScenarios">
                    <div class="loading">Calculating budget scenarios...</div>
                </div>
            </div>

            <!-- Cost History Chart -->
            <div class="card">
                <h3>üìä Cost History</h3>
                <div class="cost-history">
                    <div>Cost history visualization coming soon...</div>
                </div>
            </div>

            <!-- Optimization Recommendations -->
            <div class="card">
                <h3>üéØ Optimization Recommendations</h3>
                <div id="recommendations">
                    <div class="loading">Generating recommendations...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBudget = 100;
        let costData = {};

        function updateBudget() {
            const budget = document.getElementById('monthlyBudget').value;
            currentBudget = parseFloat(budget);
            
            if (currentBudget < 1) {
                alert('Budget must be at least $1');
                return;
            }
            
            // Refresh analysis with new budget
            loadCostAnalysis();
        }

        async function resetSessionCost() {
            try {
                const response = await fetch('/api/reset_session_cost', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    alert('Session cost tracking reset successfully');
                    loadCostAnalysis();
                } else {
                    alert('Error resetting session cost: ' + data.error);
                }
            } catch (error) {
                alert('Error resetting session cost: ' + error.message);
            }
        }

        async function loadCostAnalysis() {
            try {
                const response = await fetch(`/api/cost_analysis?budget=${currentBudget}`);
                const data = await response.json();
                
                if (response.ok) {
                    updateCostDisplay(data);
                } else {
                    console.error('Error loading cost analysis:', data.error);
                }
            } catch (error) {
                console.error('Error loading cost analysis:', error);
            }
        }

        function updateCostDisplay(data) {
            costData = data;

            // Update current costs
            document.getElementById('todayCost').textContent = `$${data.current_costs.today_cost.toFixed(2)}`;
            document.getElementById('monthCost').textContent = `$${data.current_costs.monthly_cost.toFixed(2)}`;
            document.getElementById('totalCost').textContent = `$${data.current_costs.total_cost.toFixed(2)}`;
            document.getElementById('sessionCost').textContent = `$${data.current_costs.session_cost.toFixed(4)}`;

            // Update budget progress
            const utilization = data.budget_analysis.budget_utilization;
            const remaining = data.budget_analysis.budget_remaining;
            
            document.getElementById('budgetPercent').textContent = `${utilization.toFixed(1)}%`;
            document.getElementById('budgetProgress').style.width = `${Math.min(utilization, 100)}%`;
            document.getElementById('budgetRemaining').textContent = `$${remaining.toFixed(2)} remaining`;

            // Update budget alert
            const alertDiv = document.getElementById('budgetAlert');
            alertDiv.style.display = 'block';
            
            if (remaining < 0) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = `‚ö†Ô∏è OVER BUDGET by $${Math.abs(remaining).toFixed(2)}! Consider reducing usage.`;
            } else if (utilization > 80) {
                alertDiv.className = 'alert alert-warning';
                alertDiv.textContent = `‚ö†Ô∏è High budget utilization (${utilization.toFixed(1)}%). Monitor usage closely.`;
            } else {
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = `‚úÖ Budget healthy. ${data.budget_analysis.days_remaining} days remaining at current pace.`;
            }

            // Update collection estimates
            document.getElementById('costPerArticle').textContent = `$${data.collection_estimates.cost_per_article.toFixed(4)}`;
            document.getElementById('fullRunCost').textContent = `$${data.collection_estimates.full_run_cost.toFixed(2)}`;
            document.getElementById('collectionsPerMonth').textContent = data.collection_estimates.collections_per_month;
            
            const freq = data.collection_estimates.frequency;
            document.getElementById('collectionFrequency').textContent = freq;

            // Update API breakdown
            updateApiBreakdown(data.api_usage);

            // Update budget scenarios
            updateBudgetScenarios(data.budget_scenarios);

            // Update recommendations
            updateRecommendations(data.recommendations);
        }

        function updateApiBreakdown(apiUsage) {
            const container = document.getElementById('apiBreakdown');
            container.innerHTML = '';

            if (!apiUsage || Object.keys(apiUsage).length === 0) {
                container.innerHTML = '<div class="loading">No API usage data available</div>';
                return;
            }

            Object.entries(apiUsage).forEach(([apiName, usage]) => {
                if (usage.calls > 0) {
                    const item = document.createElement('div');
                    item.className = 'api-item';
                    item.innerHTML = `
                        <div class="api-name">${apiName}</div>
                        <div class="api-stat">
                            <span class="api-stat-label">Calls:</span>
                            <span class="api-stat-value">${usage.calls.toLocaleString()}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Tokens:</span>
                            <span class="api-stat-value">${usage.tokens.toLocaleString()}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Cost:</span>
                            <span class="api-stat-value">$${usage.cost.toFixed(4)}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Per Call:</span>
                            <span class="api-stat-value">$${(usage.cost / usage.calls).toFixed(4)}</span>
                        </div>
                    `;
                    container.appendChild(item);
                }
            });
        }

        function updateBudgetScenarios(scenarios) {
            const container = document.getElementById('budgetScenarios');
            container.innerHTML = '';

            scenarios.forEach(scenario => {
                const item = document.createElement('div');
                item.className = 'scenario-item';
                item.innerHTML = `
                    <div class="scenario-budget">$${scenario.budget}/month</div>
                    <div class="scenario-details">
                        ${scenario.collections} collections<br>
                        ${scenario.frequency}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="loading">No specific recommendations available</div>';
                return;
            }

            container.innerHTML = `
                <div class="recommendations">
                    <h4>üí° Cost Optimization Tips</h4>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCostAnalysis();
            
            // Auto-refresh every 30 seconds
            setInterval(loadCostAnalysis, 30000);
        });

        // Update budget when Enter is pressed
        document.getElementById('monthlyBudget').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateBudget();
            }
        });
    </script>
    </div>
{% endblock %}

{% block scripts %}
<script>
let currentBudget = 100;
        let costData = {};

        function updateBudget() {
            const budget = document.getElementById('monthlyBudget').value;
            currentBudget = parseFloat(budget);
            
            if (currentBudget < 1) {
                alert('Budget must be at least $1');
                return;
            }
            
            // Refresh analysis with new budget
            loadCostAnalysis();
        }

        async function resetSessionCost() {
            try {
                const response = await fetch('/api/reset_session_cost', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    alert('Session cost tracking reset successfully');
                    loadCostAnalysis();
                } else {
                    alert('Error resetting session cost: ' + data.error);
                }
            } catch (error) {
                alert('Error resetting session cost: ' + error.message);
            }
        }

        async function loadCostAnalysis() {
            try {
                const response = await fetch(`/api/cost_analysis?budget=${currentBudget}`);
                const data = await response.json();
                
                if (response.ok) {
                    updateCostDisplay(data);
                } else {
                    console.error('Error loading cost analysis:', data.error);
                }
            } catch (error) {
                console.error('Error loading cost analysis:', error);
            }
        }

        function updateCostDisplay(data) {
            costData = data;

            // Update current costs
            document.getElementById('todayCost').textContent = `$${data.current_costs.today_cost.toFixed(2)}`;
            document.getElementById('monthCost').textContent = `$${data.current_costs.monthly_cost.toFixed(2)}`;
            document.getElementById('totalCost').textContent = `$${data.current_costs.total_cost.toFixed(2)}`;
            document.getElementById('sessionCost').textContent = `$${data.current_costs.session_cost.toFixed(4)}`;

            // Update budget progress
            const utilization = data.budget_analysis.budget_utilization;
            const remaining = data.budget_analysis.budget_remaining;
            
            document.getElementById('budgetPercent').textContent = `${utilization.toFixed(1)}%`;
            document.getElementById('budgetProgress').style.width = `${Math.min(utilization, 100)}%`;
            document.getElementById('budgetRemaining').textContent = `$${remaining.toFixed(2)} remaining`;

            // Update budget alert
            const alertDiv = document.getElementById('budgetAlert');
            alertDiv.style.display = 'block';
            
            if (remaining < 0) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = `‚ö†Ô∏è OVER BUDGET by $${Math.abs(remaining).toFixed(2)}! Consider reducing usage.`;
            } else if (utilization > 80) {
                alertDiv.className = 'alert alert-warning';
                alertDiv.textContent = `‚ö†Ô∏è High budget utilization (${utilization.toFixed(1)}%). Monitor usage closely.`;
            } else {
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = `‚úÖ Budget healthy. ${data.budget_analysis.days_remaining} days remaining at current pace.`;
            }

            // Update collection estimates
            document.getElementById('costPerArticle').textContent = `$${data.collection_estimates.cost_per_article.toFixed(4)}`;
            document.getElementById('fullRunCost').textContent = `$${data.collection_estimates.full_run_cost.toFixed(2)}`;
            document.getElementById('collectionsPerMonth').textContent = data.collection_estimates.collections_per_month;
            
            const freq = data.collection_estimates.frequency;
            document.getElementById('collectionFrequency').textContent = freq;

            // Update API breakdown
            updateApiBreakdown(data.api_usage);

            // Update budget scenarios
            updateBudgetScenarios(data.budget_scenarios);

            // Update recommendations
            updateRecommendations(data.recommendations);
        }

        function updateApiBreakdown(apiUsage) {
            const container = document.getElementById('apiBreakdown');
            container.innerHTML = '';

            if (!apiUsage || Object.keys(apiUsage).length === 0) {
                container.innerHTML = '<div class="loading">No API usage data available</div>';
                return;
            }

            Object.entries(apiUsage).forEach(([apiName, usage]) => {
                if (usage.calls > 0) {
                    const item = document.createElement('div');
                    item.className = 'api-item';
                    item.innerHTML = `
                        <div class="api-name">${apiName}</div>
                        <div class="api-stat">
                            <span class="api-stat-label">Calls:</span>
                            <span class="api-stat-value">${usage.calls.toLocaleString()}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Tokens:</span>
                            <span class="api-stat-value">${usage.tokens.toLocaleString()}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Cost:</span>
                            <span class="api-stat-value">$${usage.cost.toFixed(4)}</span>
                        </div>
                        <div class="api-stat">
                            <span class="api-stat-label">Per Call:</span>
                            <span class="api-stat-value">$${(usage.cost / usage.calls).toFixed(4)}</span>
                        </div>
                    `;
                    container.appendChild(item);
                }
            });
        }

        function updateBudgetScenarios(scenarios) {
            const container = document.getElementById('budgetScenarios');
            container.innerHTML = '';

            scenarios.forEach(scenario => {
                const item = document.createElement('div');
                item.className = 'scenario-item';
                item.innerHTML = `
                    <div class="scenario-budget">$${scenario.budget}/month</div>
                    <div class="scenario-details">
                        ${scenario.collections} collections<br>
                        ${scenario.frequency}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="loading">No specific recommendations available</div>';
                return;
            }

            container.innerHTML = `
                <div class="recommendations">
                    <h4>üí° Cost Optimization Tips</h4>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCostAnalysis();
            
            // Auto-refresh every 30 seconds
            setInterval(loadCostAnalysis, 30000);
        });

        // Update budget when Enter is pressed
        document.getElementById('monthlyBudget').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateBudget();
            }
        });
</script>
{% endblock %}
