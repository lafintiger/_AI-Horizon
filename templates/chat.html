{% extends "base.html" %}

{% block title %}AI Chat - AI-Horizon{% endblock %}

{% block extra_styles %}
<style>
    .chat-container {
        display: grid;
        grid-template-columns: 300px 1fr 280px;
        gap: 20px;
        height: calc(100vh - 200px);
        max-height: 800px;
    }

    .chat-sidebar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }

    .chat-main {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .model-selector {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        padding: 8px 12px;
        font-size: 0.9rem;
    }

    .model-selector option {
        background: #333;
        color: white;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 85%;
        padding: 15px 20px;
        border-radius: 18px;
        line-height: 1.6;
        word-wrap: break-word;
    }

    .message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 5px;
    }

    .message.assistant {
        align-self: flex-start;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
        color: #333;
    }

    .message-meta {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 8px;
    }

    .message-sources {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .source-item {
        background: rgba(0, 0, 0, 0.05);
        padding: 8px 12px;
        border-radius: 8px;
        margin: 5px 0;
        font-size: 0.85rem;
    }

    .source-title {
        font-weight: 600;
        color: #667eea;
        text-decoration: none;
    }

    .source-title:hover {
        text-decoration: underline;
    }

    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    .input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        min-height: 50px;
        max-height: 120px;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 1rem;
        resize: none;
        font-family: inherit;
        transition: border-color 0.3s ease;
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .send-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: transform 0.2s ease;
    }

    .send-button:hover {
        transform: scale(1.05);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .suggestions-section {
        margin-bottom: 20px;
    }

    .suggestion-item {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 8px;
        padding: 10px;
        margin: 5px 0;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .suggestion-item:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
    }

    .filters-section {
        margin-bottom: 20px;
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        font-size: 0.9rem;
    }

    .filter-checkbox {
        margin-right: 8px;
    }

    .filter-option {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 0.85rem;
    }

    .stats-section {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 0.85rem;
    }

    .stat-value {
        font-weight: 600;
        color: #667eea;
    }

    .export-section {
        margin-top: 20px;
    }

    .export-button {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        width: 100%;
        margin: 5px 0;
        transition: background-color 0.3s ease;
    }

    .export-button:hover {
        background: #218838;
    }

    .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #667eea;
        font-style: italic;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }

    .dcwf-context {
        background: rgba(118, 75, 162, 0.1);
        border-left: 4px solid #764ba2;
        padding: 15px;
        margin: 10px 0;
        border-radius: 0 8px 8px 0;
    }

    .dcwf-role {
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .dcwf-role-title {
        font-weight: 600;
        color: #764ba2;
    }

    @media (max-width: 1200px) {
        .chat-container {
            grid-template-columns: 250px 1fr 250px;
        }
    }

    @media (max-width: 768px) {
        .chat-container {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr auto;
            height: calc(100vh - 150px);
        }
        
        .chat-sidebar {
            order: 3;
            height: auto;
            max-height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Left Sidebar - Suggestions & Filters -->
    <div class="chat-sidebar">
        <div class="suggestions-section">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #333;">üí° Suggested Questions</h3>
            <div id="suggestions-list">
                <!-- Suggestions will be loaded here -->
            </div>
        </div>

        <div class="filters-section">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #333;">üîç Filters</h3>
            
            <div class="filter-group">
                <label class="filter-label">AI Impact Categories</label>
                <div class="filter-option">
                    <input type="checkbox" id="filter-replace" class="filter-checkbox" value="replace">
                    <label for="filter-replace">ü§ñ AI Replace</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filter-augment" class="filter-checkbox" value="augment">
                    <label for="filter-augment">ü§ù AI Augment</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filter-new" class="filter-checkbox" value="new_tasks">
                    <label for="filter-new">‚ú® New Tasks</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filter-human" class="filter-checkbox" value="human_only">
                    <label for="filter-human">üë§ Human Only</label>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Confidence Threshold</label>
                <input type="range" id="confidence-slider" min="0" max="1" step="0.1" value="0.3" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                    <span>Low</span>
                    <span id="confidence-value">0.3</span>
                    <span>High</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-header">
            <h1 class="chat-title">ü§ñ AI-Horizon Chat</h1>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                <select id="model-selector" class="model-selector">
                    {% for model in available_models %}
                    <option value="{{ model }}" {% if loop.first %}selected{% endif %}>{{ model }}</option>
                    {% endfor %}
                </select>
                <div id="model-info" style="font-size: 0.8rem; opacity: 0.8; text-align: right;">
                    Loading model info...
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="message assistant">
                <div>
                    üëã Welcome to AI-Horizon Chat! I'm your cybersecurity workforce intelligence assistant.
                    
                    I have access to <strong>{{ database_stats.total_articles or 0 }}</strong> analyzed articles covering:
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ü§ñ <strong>{{ database_stats.categories.replace or 0 }}</strong> articles on AI replacing tasks</li>
                        <li>ü§ù <strong>{{ database_stats.categories.augment or 0 }}</strong> articles on AI augmenting work</li>
                        <li>‚ú® <strong>{{ database_stats.categories.new_tasks or 0 }}</strong> articles on new AI-created roles</li>
                        <li>üë§ <strong>{{ database_stats.categories.human_only or 0 }}</strong> articles on uniquely human tasks</li>
                    </ul>
                    
                    Plus integrated DoD Cybersecurity Workforce Framework (DCWF) data with 52 work roles and 1000+ tasks.
                    
                    Ask me anything about cybersecurity careers, AI impact, or specific tasks and roles!
                </div>
                <div class="message-meta">
                    System ‚Ä¢ {{ database_stats.total_articles or 0 }} articles available
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="input-container">
                <textarea 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Ask about cybersecurity careers, AI impact, specific tasks, or DCWF roles..."
                    rows="1"></textarea>
                <button id="send-button" class="send-button" title="Send message">
                    <span>üì§</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Right Sidebar - Context & Export -->
    <div class="chat-sidebar">
        <div class="stats-section">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #333;">üìä Database Stats</h3>
            <div class="stat-item">
                <span>Total Articles:</span>
                <span class="stat-value">{{ database_stats.total_articles or 0 }}</span>
            </div>
            <div class="stat-item">
                <span>AI Replace:</span>
                <span class="stat-value">{{ database_stats.categories.replace or 0 }}</span>
            </div>
            <div class="stat-item">
                <span>AI Augment:</span>
                <span class="stat-value">{{ database_stats.categories.augment or 0 }}</span>
            </div>
            <div class="stat-item">
                <span>New Tasks:</span>
                <span class="stat-value">{{ database_stats.categories.new_tasks or 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Human Only:</span>
                <span class="stat-value">{{ database_stats.categories.human_only or 0 }}</span>
            </div>
        </div>

        <div class="export-section">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #333;">üíæ Export Chat</h3>
            <button id="export-markdown" class="export-button">üìù Export as Markdown</button>
            <button id="export-json" class="export-button">üìã Export as JSON</button>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; font-size: 0.85rem;">
            <h4 style="margin-bottom: 10px; color: #667eea;">üéØ Pro Tips</h4>
            <ul style="margin: 0; padding-left: 15px; line-height: 1.5;">
                <li>Ask about specific cybersecurity tasks</li>
                <li>Reference DCWF work roles by name</li>
                <li>Use filters to focus on specific AI impact categories</li>
                <li>Ask for career guidance and skill recommendations</li>
            </ul>
        </div>
    </div>
</div>

<script>
let conversation = [];
let isLoading = false;

// Initialize chat interface
document.addEventListener('DOMContentLoaded', function() {
    loadSuggestions();
    loadModelInfo();
    setupEventListeners();
    autoResizeTextarea();
});

function setupEventListeners() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const confidenceSlider = document.getElementById('confidence-slider');
    const confidenceValue = document.getElementById('confidence-value');
    const modelSelector = document.getElementById('model-selector');

    // Send message on button click
    sendButton.addEventListener('click', sendMessage);

    // Send message on Enter (but allow Shift+Enter for new lines)
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Model selector change
    modelSelector.addEventListener('change', updateModelInfo);

    // Update confidence value display
    confidenceSlider.addEventListener('input', function() {
        confidenceValue.textContent = this.value;
    });

    // Export buttons
    document.getElementById('export-markdown').addEventListener('click', () => exportChat('markdown'));
    document.getElementById('export-json').addEventListener('click', () => exportChat('json'));

    // Suggestion clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-item')) {
            document.getElementById('chat-input').value = e.target.textContent;
            sendMessage();
        }
    });
}

function autoResizeTextarea() {
    const textarea = document.getElementById('chat-input');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
}

async function loadSuggestions() {
    try {
        const response = await fetch('/api/chat/suggestions');
        const data = await response.json();
        
        const suggestionsList = document.getElementById('suggestions-list');
        suggestionsList.innerHTML = '';
        
        data.suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            suggestionsList.appendChild(div);
        });
    } catch (error) {
        console.error('Error loading suggestions:', error);
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message || isLoading) return;
    
    // Add user message to chat
    addMessage('user', message);
    input.value = '';
    input.style.height = 'auto';
    
    // Show loading
    isLoading = true;
    const loadingDiv = addMessage('assistant', '<div class="loading"><div class="loading-spinner"></div>Thinking...</div>');
    updateSendButton();
    
    try {
        // Get selected filters
        const filters = getSelectedFilters();
        let model = document.getElementById('model-selector').value;
        
        // Convert display name back to API format
        if (model.startsWith('Local (default:')) {
            model = 'local';
        }
        
        // Send to API
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: message,
                model: model,
                filters: filters
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        loadingDiv.remove();
        
        if (data.error) {
            addMessage('assistant', `<div class="error-message">‚ùå Error: ${data.error}</div>`);
        } else {
            // Add assistant response
            let responseHtml = data.response;
            
            // Add sources if available
            if (data.sources && data.sources.length > 0) {
                responseHtml += '<div class="message-sources"><strong>üìö Sources:</strong>';
                data.sources.forEach((source, index) => {
                    responseHtml += `
                        <div class="source-item">
                            <a href="${source.url}" target="_blank" class="source-title">
                                ${index + 1}. ${source.title}
                            </a>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                                ${source.source_type} ‚Ä¢ Relevance: ${source.relevance_score}
                            </div>
                        </div>
                    `;
                });
                responseHtml += '</div>';
            }
            
            const assistantMessage = addMessage('assistant', responseHtml);
            
            // Add metadata
            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = `${data.context_stats.model_used} ‚Ä¢ ${data.context_stats.articles_used} articles used`;
            assistantMessage.appendChild(meta);
            
            // Store in conversation for export
            conversation.push(
                { role: 'user', content: message, timestamp: new Date().toISOString() },
                { role: 'assistant', content: data.response, sources: data.sources, timestamp: new Date().toISOString() }
            );
        }
        
    } catch (error) {
        // Remove loading message
        loadingDiv.remove();
        addMessage('assistant', `<div class="error-message">‚ùå Network error: ${error.message}</div>`);
    } finally {
        isLoading = false;
        updateSendButton();
    }
}

function addMessage(role, content) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = content;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageDiv;
}

function getSelectedFilters() {
    const filters = {};
    
    // Get category filters
    const categoryFilters = [];
    document.querySelectorAll('.filter-checkbox:checked').forEach(checkbox => {
        categoryFilters.push(checkbox.value);
    });
    if (categoryFilters.length > 0) {
        filters.categories = categoryFilters;
    }
    
    // Get confidence threshold
    const confidence = document.getElementById('confidence-slider').value;
    if (confidence > 0) {
        filters.confidence_threshold = parseFloat(confidence);
    }
    
    return filters;
}

function updateSendButton() {
    const sendButton = document.getElementById('send-button');
    sendButton.disabled = isLoading;
    sendButton.innerHTML = isLoading ? '<div class="loading-spinner" style="width: 16px; height: 16px;"></div>' : '<span>üì§</span>';
}

async function exportChat(format) {
    if (conversation.length === 0) {
        alert('No conversation to export!');
        return;
    }
    
    try {
        const response = await fetch('/api/chat/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conversation: conversation,
                format: format
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Chat exported successfully as ${data.filename}`);
        } else {
            alert(`Export failed: ${data.error}`);
        }
    } catch (error) {
        alert(`Export error: ${error.message}`);
    }
}

let availableModels = [];

async function loadModelInfo() {
    try {
        const response = await fetch('/api/chat/available_models');
        const data = await response.json();
        
        if (data.available_models) {
            availableModels = data.available_models;
            updateModelSelector();
            updateModelInfo();
        }
    } catch (error) {
        console.error('Error loading model info:', error);
        document.getElementById('model-info').textContent = 'Model info unavailable';
    }
}

function updateModelSelector() {
    const modelSelector = document.getElementById('model-selector');
    const currentValue = modelSelector.value;
    
    // Clear existing options except external APIs
    const externalModels = ['claude-3-5-sonnet-20241022', 'claude-3-haiku-20240307', 'gpt-4o', 'gpt-4o-mini', 'gpt-3.5-turbo'];
    
    // Rebuild selector with local models first
    modelSelector.innerHTML = '';
    
    // Add "Auto (Default Local)" option
    const autoOption = document.createElement('option');
    autoOption.value = 'local';
    autoOption.textContent = 'ü§ñ Auto (Default Local)';
    modelSelector.appendChild(autoOption);
    
    // Add specific local models by category
    const categories = ['Fast & Lightweight', 'Balanced Performance', 'High-Performance', 'Specialized', 'Premium Large'];
    
    categories.forEach(category => {
        const categoryModels = availableModels.filter(m => m.category === category);
        if (categoryModels.length > 0) {
            // Add category header
            const optgroup = document.createElement('optgroup');
            optgroup.label = `${category} Models`;
            
            categoryModels.forEach(model => {
                const option = document.createElement('option');
                option.value = `local:${model.model_id}`;
                option.textContent = `${model.name} (${model.size})`;
                optgroup.appendChild(option);
            });
            
            modelSelector.appendChild(optgroup);
        }
    });
    
    // Add external APIs
    const externalOptgroup = document.createElement('optgroup');
    externalOptgroup.label = 'External APIs';
    externalModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model.replace('-', ' ').toUpperCase();
        externalOptgroup.appendChild(option);
    });
    modelSelector.appendChild(externalOptgroup);
    
    // Restore selection or default to first option
    modelSelector.value = currentValue || 'local';
}

function updateModelInfo() {
    const modelSelector = document.getElementById('model-selector');
    const modelInfo = document.getElementById('model-info');
    const selectedModel = modelSelector.value;
    
    if (selectedModel === 'local') {
        // Find default model
        const defaultModel = availableModels.find(m => m.default) || availableModels.find(m => m.model_id === 'mistral-nemo:12b-instruct-2407-q6_K');
        if (defaultModel) {
            modelInfo.innerHTML = `${defaultModel.name}<br>${defaultModel.description}`;
        } else {
            modelInfo.textContent = 'Default local model (Mistral Nemo 12B)';
        }
    } else if (selectedModel.startsWith('local:')) {
        const modelId = selectedModel.substring(6);
        const model = availableModels.find(m => m.model_id === modelId);
        if (model) {
            modelInfo.innerHTML = `${model.name} ‚Ä¢ ${model.params}<br>${model.description}`;
        } else {
            modelInfo.textContent = `Local: ${modelId}`;
        }
    } else {
        // External API
        modelInfo.textContent = `External API: ${selectedModel}`;
    }
}
</script>
{% endblock %} 