{% extends "base.html" %}

{% block title %}Analysis Tools - AI-Horizon{% endblock %}

{% block extra_styles %}
<style>

        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        /* Visualization Modal Styles */
        .viz-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .viz-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .viz-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .viz-close:hover {
            color: #e74c3c;
        }
        
        .viz-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .viz-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .viz-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .viz-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .viz-content {
            display: none;
        }
        
        .viz-content.active {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        /* Enhanced Analysis Card Styles */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-icon {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .card-description {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .features-list {
            list-style: none;
            margin-bottom: 25px;
        }
        
        .features-list li {
            padding: 5px 0;
            color: #34495e;
            position: relative;
            padding-left: 20px;
        }
        
        .features-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .run-button {
            flex: 1;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 150px;
        }
        
        .viz-button {
            flex: 1;
            padding: 15px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 150px;
        }
        
        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .viz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }
        
        .run-button:disabled, .viz-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .results h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .result-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .result-label {
            font-weight: bold;
            color: #34495e;
            display: inline-block;
            width: 150px;
        }
        
        .result-value {
            color: #667eea;
            font-weight: bold;
        }
        
        .report-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        
        .report-link:hover {
            background: #219a52;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #e74c3c;
            margin-top: 15px;
        }
        
        .success {
            color: #27ae60;
            background: #f2fdf5;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #27ae60;
            margin-top: 15px;
        }
        
        /* Comprehensive Category Narratives Styling */
        .narrative-content {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .narrative-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        
        .narrative-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-width: 150px;
        }
        
        .jobs-tasks-section, .top-articles-section {
            margin-bottom: 25px;
        }
        
        .jobs-tasks-section h4, .top-articles-section h4 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .job-item, .article-item {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .job-title, .article-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .job-confidence, .job-evidence, .article-metrics, .article-evidence {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .job-citations ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .job-citations li {
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .article-insight {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-style: italic;
            border-left: 3px solid #007bff;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        /* Enhanced Category Distribution Insights Styling */
        .card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        
        .feature-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .card-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3748;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-1px);
        }
        
        .card-results {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .result-metric .metric-label {
            color: #4a5568;
            font-weight: 500;
        }
        
        .result-metric .metric-value {
            color: #2d3748;
            font-weight: bold;
        }
        
        /* Visualization Modal Styling */
        .visualization-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .close-modal {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close-modal:hover {
            opacity: 0.7;
        }
        
        .modal-
        
        .visualization-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-button:hover {
            background: #e2e8f0;
            color: #2d3748;
        }
        
        .tab-button.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
            background: white;
        }
        
        .visualization-tab {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .visualization-tab.active {
            display: block;
        }
        
        .visualization-tab h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.3em;
        }
        
        .chart-insights {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        
        .chart-insights p {
            margin: 0;
            color: #4a5568;
            line-height: 1.5;
        }
        
        /* Chart container styling */
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        
        #categoryNetworkChart {
            min-height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #fafafa;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .card-metrics {
                grid-template-columns: 1fr;
            }
            
            .results-summary {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .visualization-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: left;
                border-bottom: none;
                border-right: 3px solid transparent;
            }
            
            .tab-button.active {
                border-bottom: none;
                border-right-color: #4299e1;
            }
        }
</style>
{% endblock %}

{% block content %}
    <div class="main-content">
<!-- Navigation Header -->
        
        
        <div class="header">
            <h1>📊 Analysis Dashboard</h1>
            <p>Advanced analytics and monitoring for AI-Horizon collection system</p>
        </div>
        
        <div class="analysis-grid">
            <!-- Quality Distribution Analysis Card -->
            <div class="analysis-card">
                <div class="card-header">
                    <div class="card-icon">📈</div>
                    <div class="card-title">Quality Distribution Analysis</div>
                </div>
                <div class="card-description">
                    Comprehensive analysis of document quality patterns to optimize collection strategies and identify the most valuable sources.
                </div>
                <ul class="features-list">
                    <li>Quality distribution by AI impact category</li>
                    <li>Source quality assessment and ranking</li>
                    <li>Quality trends over time analysis</li>
                    <li>Content characteristics correlation</li>
                    <li>Actionable optimization recommendations</li>
                </ul>
                <div class="button-group">
                    <button class="run-button" onclick="runQualityAnalysis()">
                        🚀 Run Analysis
                    </button>
                    <button class="viz-button" onclick="openVisualization('quality')">
                        📊 View Charts
                    </button>
                </div>
                <div class="loading" id="qualityLoading">
                    <div class="spinner"></div>
                    <span>Analyzing quality distribution patterns...</span>
                </div>
                <div class="results" id="qualityResults"></div>
            </div>
            
            <!-- Collection Monitoring Card -->
            <div class="analysis-card">
                <div class="card-header">
                    <div class="card-icon">🔍</div>
                    <div class="card-title">Collection Monitoring Dashboard</div>
                </div>
                <div class="card-description">
                    Real-time monitoring and health assessment of collection activities with performance analytics and anomaly detection.
                </div>
                <ul class="features-list">
                    <li>Live collection velocity tracking</li>
                    <li>Source health and reliability assessment</li>
                    <li>Collection efficiency metrics</li>
                    <li>Anomaly detection and alerts</li>
                    <li>Performance optimization insights</li>
                </ul>
                <div class="button-group">
                    <button class="run-button" onclick="runCollectionMonitoring()">
                        🎯 Run Monitoring
                    </button>
                    <button class="viz-button" onclick="openVisualization('monitoring')">
                        📊 View Charts
                    </button>
                </div>
                <div class="loading" id="monitoringLoading">
                    <div class="spinner"></div>
                    <span>Analyzing collection performance...</span>
                </div>
                <div class="results" id="monitoringResults"></div>
            </div>
            
            <!-- Trend Analysis Card -->
            <div class="analysis-card" id="trend-analysis-card">
                <div class="card-header">
                    <div class="card-icon">📊</div>
                    <div class="card-title">Comprehensive Trend Analysis</div>
                </div>
                <div class="card-description">
                    Deep temporal analysis of collected articles revealing quality trends, topic evolution, sentiment patterns, and collection insights over time.
                </div>
                <ul class="features-list">
                    <li>Quality trends across time periods</li>
                    <li>Topic emergence and decline tracking</li>
                    <li>Sentiment evolution analysis</li>
                    <li>Collection pattern insights</li>
                    <li>Predictive trend indicators</li>
                </ul>
                <div class="button-group">
                    <button class="run-button" onclick="runTrendAnalysis()">
                        📊 Run Analysis
                    </button>
                    <button class="viz-button" onclick="openVisualization('trends')">
                        📈 View Charts
                    </button>
                </div>
                <div class="loading" id="trendLoading">
                    <div class="spinner"></div>
                    <span>Analyzing temporal trends and patterns...</span>
                </div>
                <div class="results" id="trendResults"></div>
            </div>
            
            <!-- Job Market Sentiment Analysis Card -->
            <div class="analysis-card" id="job-sentiment-card">
                <div class="card-header">
                    <div class="card-icon">🎯</div>
                    <div class="card-title">Job Market Sentiment Tracking</div>
                </div>
                <div class="card-description">
                    Comprehensive sentiment analysis of AI's impact on cybersecurity careers, tracking opportunities vs threats, skill demand, and stakeholder perspectives.
                </div>
                <ul class="features-list">
                    <li>Overall job market sentiment analysis</li>
                    <li>Career opportunities vs threats balance</li>
                    <li>Skill demand sentiment tracking</li>
                    <li>Employer vs employee perspective analysis</li>
                    <li>Strategic career development recommendations</li>
                </ul>
                <div class="button-group">
                    <button class="run-button" onclick="runJobMarketSentiment()">🚀 Run Sentiment Analysis</button>
                    <button class="viz-button" onclick="openVisualization('sentiment')">📊 View Charts</button>
                </div>
                
                <!-- Loading Animation -->
                <div class="loading-container" id="sentimentLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Analyzing job market sentiment across collected articles...</div>
                </div>
                
                <!-- Results Display -->
                <div class="results-container" id="sentimentResults" style="display: none;">
                    <h3>📊 Sentiment Analysis Results</h3>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">Overall Sentiment</div>
                            <div class="result-value" id="overallSentiment">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Opportunity/Threat Ratio</div>
                            <div class="result-value" id="opportunityRatio">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Dominant Narrative</div>
                            <div class="result-value" id="dominantNarrative">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Top Skill in Demand</div>
                            <div class="result-value" id="topSkill">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Employer Sentiment</div>
                            <div class="result-value" id="employerSentiment">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Employee Sentiment</div>
                            <div class="result-value" id="employeeSentiment">-</div>
                        </div>
                    </div>
                    <div class="view-report">
                        <a href="#" id="sentimentReportLink" target="_blank">📄 View Detailed Report</a>
                    </div>
                </div>
            </div>
            
            <!-- AI Adoption Rate Predictions Card -->
            <div class="analysis-card" id="ai-adoption-card">
                <div class="card-header">
                    <div class="card-icon">🚀</div>
                    <div class="card-title">AI Adoption Rate Predictions</div>
                </div>
                <div class="card-description">
                    Predictive analysis of AI adoption patterns in cybersecurity focusing on DCWF task transformation, skill demand forecasting, and workforce evolution predictions.
                </div>
                <ul class="features-list">
                    <li>DCWF task transformation analysis by AI impact category</li>
                    <li>Cybersecurity skill demand forecasting and ranking</li>
                    <li>Workforce transformation velocity predictions</li>
                    <li>Technology adoption curve analysis with timeline</li>
                    <li>Strategic workforce development recommendations</li>
                </ul>
                <div class="button-group">
                    <button class="run-button" onclick="runAIAdoptionPredictions()">🔮 Run DCWF Task Analysis</button>
                    <button class="viz-button" onclick="openVisualization('adoption')">📊 View Charts</button>
                </div>
                
                <!-- Loading Animation -->
                <div class="loading-container" id="adoptionLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Analyzing AI adoption patterns and forecasting DCWF task transformation...</div>
                </div>
                
                <!-- Results Display -->
                <div class="results-container" id="adoptionResults" style="display: none;">
                    <h3>🚀 AI Adoption Predictions Results</h3>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">Articles Analyzed</div>
                            <div class="result-value" id="adoptionAnalyzed">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Current Adoption Phase</div>
                            <div class="result-value" id="adoptionPhase">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Transformation Speed</div>
                            <div class="result-value" id="transformationSpeed">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Top High-Demand Skills</div>
                            <div class="result-value" id="topSkills">-</div>
                        </div>
                    </div>
                    <div class="features-completed">
                        <h4>✅ Analysis Features Completed:</h4>
                        <ul id="completedFeatures">
                            <!-- Features will be populated dynamically -->
                        </ul>
                    </div>
                    <div class="view-report">
                        <a href="#" id="adoptionReportLink" target="_blank">📄 View Detailed Predictions Report</a>
                    </div>
                </div>
            </div>
            
            <!-- Category Distribution Insights Card -->
            <div class="analysis-card" id="category-distribution-card">
                <div class="card-header">
                    <div class="card-icon">📊</div>
                    <div class="card-title">Category Distribution Insights</div>
                </div>
                <div class="card-description">
                    Deep analysis of AI impact category patterns and evolution, focusing on DCWF task distribution and workforce transformation with advanced temporal analysis, predictive modeling, and interactive visualizations.
                </div>
                <div class="card-features">
                    <span class="feature-tag">🎯 Distribution Analysis</span>
                    <span class="feature-tag">📈 Trend Predictions</span>
                    <span class="feature-tag">🔗 Relationship Mapping</span>
                    <span class="feature-tag">📊 Interactive Charts</span>
                    <span class="feature-tag">🔮 ML Predictions</span>
                    <span class="feature-tag">📋 DCWF Insights</span>
                </div>
                <div class="card-metrics">
                    <div class="metric">
                        <span class="metric-label">Categories:</span>
                        <span class="metric-value" id="categoryDistributionCategories">5</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Balance Score:</span>
                        <span class="metric-value" id="categoryDistributionBalance">0.70</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Visualization:</span>
                        <span class="metric-value">Interactive</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn-primary" onclick="runCategoryDistributionInsights()">🚀 Run Advanced Analysis</button>
                    <button class="btn-secondary" onclick="showCategoryVisualization()">📊 View Interactive Charts</button>
                </div>
                <div class="card-results" id="categoryDistributionResults" style="display: none;">
                    <div class="results-summary">
                        <div class="result-metric">
                            <span class="metric-label">Articles Analyzed:</span>
                            <span class="metric-value" id="categoryArticlesAnalyzed">-</span>
                        </div>
                        <div class="result-metric">
                            <span class="metric-label">Distribution Balance:</span>
                            <span class="metric-value" id="categoryBalanceScore">-</span>
                        </div>
                        <div class="result-metric">
                            <span class="metric-label">Prediction Confidence:</span>
                            <span class="metric-value" id="categoryPredictionConfidence">-</span>
                        </div>
                    </div>
                    <div class="view-report">
                        <a href="#" id="categoryDistributionReportLink" target="_blank">📄 View Comprehensive Report</a>
                    </div>
                </div>
                
                <!-- Interactive Visualization Modal -->
                <div id="categoryVisualizationModal" class="visualization-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>📊 Category Distribution Interactive Visualizations</h3>
                            <span class="close-modal" onclick="closeCategoryVisualization()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="visualization-tabs">
                                <button class="tab-button active" onclick="showVisualizationTab('distribution')">📊 Distribution</button>
                                <button class="tab-button" onclick="showVisualizationTab('evolution')">📈 Evolution</button>
                                <button class="tab-button" onclick="showVisualizationTab('network')">🔗 Relationships</button>
                                <button class="tab-button" onclick="showVisualizationTab('predictions')">🔮 Predictions</button>
                            </div>
                            
                            <div id="distributionTab" class="visualization-tab active">
                                <h4>AI Impact Category Distribution</h4>
                                <canvas id="categoryDistributionChart" width="400" height="200"></canvas>
                                <div class="chart-insights">
                                    <p><strong>Insights:</strong> Distribution balance across AI impact categories with quality metrics</p>
                                </div>
                            </div>
                            
                            <div id="evolutionTab" class="visualization-tab">
                                <h4>Category Evolution Timeline</h4>
                                <canvas id="categoryEvolutionChart" width="400" height="200"></canvas>
                                <div class="chart-insights">
                                    <p><strong>Insights:</strong> Temporal trends and statistical predictions for category evolution</p>
                                </div>
                            </div>
                            
                            <div id="networkTab" class="visualization-tab">
                                <h4>Category Relationship Network</h4>
                                <div id="categoryNetworkChart"></div>
                                <div class="chart-insights">
                                    <p><strong>Insights:</strong> Interactive network showing relationships and task overlaps between categories</p>
                                </div>
                            </div>
                            
                            <div id="predictionsTab" class="visualization-tab">
                                <h4>Predictive Analytics Dashboard</h4>
                                <canvas id="categoryPredictionsChart" width="400" height="200"></canvas>
                                <div class="chart-insights">
                                    <p><strong>Insights:</strong> Machine learning predictions with confidence intervals and trend analysis</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Comprehensive Category Narratives Card -->
            <div class="analysis-card" id="comprehensive-narratives-card">
                <div class="card-header">
                    <div class="card-icon">📖</div>
                    <div class="card-title">Comprehensive Category Narratives</div>
                </div>
                <div class="card-description">
                    Detailed narrative summaries for all AI impact categories with executive summaries, specific job/task analysis, and evidence-based explanations with citations.
                </div>
                <div class="card-features">
                    <span class="feature-tag">🤖 AI REPLACE</span>
                    <span class="feature-tag">🤝 AI AUGMENT</span>
                    <span class="feature-tag">✨ NEW TASKS</span>
                    <span class="feature-tag">👤 HUMAN-ONLY</span>
                    <span class="feature-tag">📋 Citations</span>
                    <span class="feature-tag">📊 Evidence</span>
                </div>
                <div class="card-metrics">
                    <div class="metric">
                        <span class="metric-label">Categories:</span>
                        <span class="metric-value" id="narrativesCategories">4</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Format:</span>
                        <span class="metric-value">Detailed</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Citations:</span>
                        <span class="metric-value">Included</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn-primary" onclick="runComprehensiveCategoryNarratives()">🚀 Generate Narratives</button>
                    <button class="btn-secondary" onclick="showCategoryNarratives()">📋 View Narratives</button>
                </div>
                <div class="card-results" id="narrativesResults" style="display: none;">
                    <div class="results-summary">
                        <div class="result-metric">
                            <span class="metric-label">Categories Analyzed:</span>
                            <span class="metric-value" id="narrativesCategoriesAnalyzed">-</span>
                        </div>
                        <div class="result-metric">
                            <span class="metric-label">Total Articles:</span>
                            <span class="metric-value" id="narrativesTotalArticles">-</span>
                        </div>
                        <div class="result-metric">
                            <span class="metric-label">Avg per Category:</span>
                            <span class="metric-value" id="narrativesAvgPerCategory">-</span>
                        </div>
                    </div>
                    <div class="view-report">
                        <a href="#" id="narrativesReportLink" target="_blank">📄 View Comprehensive Report</a>
                    </div>
                </div>
                
                <!-- Category Narratives Modal -->
                <div id="narrativesModal" class="visualization-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>📖 Comprehensive Category Narratives</h3>
                            <span class="close-modal" onclick="closeNarrativesModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="visualization-tabs">
                                <button class="tab-button active" onclick="showNarrativeTab('replace')">🤖 AI REPLACE</button>
                                <button class="tab-button" onclick="showNarrativeTab('augment')">🤝 AI AUGMENT</button>
                                <button class="tab-button" onclick="showNarrativeTab('new_tasks')">✨ NEW TASKS</button>
                                <button class="tab-button" onclick="showNarrativeTab('human_only')">👤 HUMAN-ONLY</button>
                            </div>
                            
                            <div id="replaceTab" class="visualization-tab active">
                                <div id="replaceNarrative">Loading AI REPLACE narrative...</div>
                            </div>
                            
                            <div id="augmentTab" class="visualization-tab">
                                <div id="augmentNarrative">Loading AI AUGMENT narrative...</div>
                            </div>
                            
                            <div id="newTasksTab" class="visualization-tab">
                                <div id="newTasksNarrative">Loading NEW TASKS narrative...</div>
                            </div>
                            
                            <div id="humanOnlyTab" class="visualization-tab">
                                <div id="humanOnlyNarrative">Loading HUMAN-ONLY narrative...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Visualization Modal -->
        <div id="vizModal" class="viz-modal">
            <div class="viz-modal-content">
                <span class="viz-close" onclick="closeVisualization()">&times;</span>
                <h2 id="vizModalTitle">Interactive Visualizations</h2>
                
                <div class="viz-tabs">
                    <button class="viz-tab active" onclick="switchVizTab('overview')">📊 Overview</button>
                    <button class="viz-tab" onclick="switchVizTab('trends')">📈 Trends</button>
                    <button class="viz-tab" onclick="switchVizTab('relationships')">🔗 Relationships</button>
                    <button class="viz-tab" onclick="switchVizTab('predictions')">🔮 Predictions</button>
                </div>
                
                <div id="vizOverview" class="viz-content active">
                    <div class="chart-title">Overview Dashboard</div>
                    <div class="chart-container">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
                
                <div id="vizTrends" class="viz-content">
                    <div class="chart-title">Temporal Trends Analysis</div>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
                
                <div id="vizRelationships" class="viz-content">
                    <div class="chart-title">Relationships & Correlations</div>
                    <div class="chart-container">
                        <canvas id="relationshipsChart"></canvas>
                    </div>
                </div>
                
                <div id="vizPredictions" class="viz-content">
                    <div class="chart-title">Predictive Analytics</div>
                    <div class="chart-container">
                        <canvas id="predictionsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <a href="/" class="nav-button">🏠 Dashboard</a>
            <a href="/reports" class="nav-button">📋 Reports</a>
            <a href="/browse_entries" class="nav-button">📚 Browse Content</a>
            <a href="/methodology" class="nav-button">📖 Methodology</a>
        </div>
    </div>

    <script>
        async function runQualityAnalysis() {
            const button = document.querySelector('.analysis-card:first-child .run-button');
            const loading = document.getElementById('qualityLoading');
            const results = document.getElementById('qualityResults');
            
            button.disabled = true;
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_quality_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                } else {
                    results.innerHTML = `
                        <h3>📈 Quality Analysis Results</h3>
                        <div class="result-item">
                            <span class="result-label">Overall Quality:</span>
                            <span class="result-value">${data.overall_quality}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Excellent Articles:</span>
                            <span class="result-value">${data.excellent_articles}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Total Analyzed:</span>
                            <span class="result-value">${data.total_analyzed}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Analysis Time:</span>
                            <span class="result-value">${new Date().toLocaleString()}</span>
                        </div>
                        ${data.report_file ? `<a href="/api/view_report?path=${encodeURIComponent(data.report_file)}" class="report-link" target="_blank">📄 View Detailed Report</a>` : ''}
                    `;
                }
                
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="error">Error running analysis: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        async function runCollectionMonitoring() {
            const button = document.querySelector('.analysis-card:nth-child(2) .run-button');
            const loading = document.getElementById('monitoringLoading');
            const results = document.getElementById('monitoringResults');
            
            button.disabled = true;
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_collection_monitoring', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hours: 24 })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                } else {
                    results.innerHTML = `
                        <h3>🔍 Collection Monitoring Results</h3>
                        <div class="result-item">
                            <span class="result-label">Collection Rate:</span>
                            <span class="result-value">${data.collection_rate} articles/hour</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Source Health:</span>
                            <span class="result-value">${data.source_health}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Quality Score:</span>
                            <span class="result-value">${data.quality_score}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Efficiency Grade:</span>
                            <span class="result-value">${data.efficiency_grade}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Analysis Time:</span>
                            <span class="result-value">${new Date().toLocaleString()}</span>
                        </div>
                        ${data.report_file ? `<a href="/api/view_report?path=${encodeURIComponent(data.report_file)}" class="report-link" target="_blank">📄 View Detailed Report</a>` : ''}
                    `;
                }
                
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="error">Error running monitoring: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        async function runTrendAnalysis() {
            const button = document.querySelector('#trend-analysis-card .run-button');
            const loading = document.getElementById('trendLoading');
            const results = document.getElementById('trendResults');
            
            button.disabled = true;
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_trend_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                } else {
                    const summary = data.analysis_summary;
                    results.innerHTML = `
                        <h3>📊 Trend Analysis Results</h3>
                        <div class="result-item">
                            <span class="result-label">Quality Trend:</span>
                            <span class="result-value">${summary.quality_trend} (${summary.quality_improvement > 0 ? '+' : ''}${summary.quality_improvement.toFixed(3)})</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Collection Consistency:</span>
                            <span class="result-value">${summary.collection_consistency.toFixed(3)}/1.0</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Positive Sentiment:</span>
                            <span class="result-value">${summary.positive_sentiment}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Topic Evolution:</span>
                            <span class="result-value">${summary.emerging_topics} emerging, ${summary.declining_topics} declining</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Data Points:</span>
                            <span class="result-value">${data.data_count} articles analyzed</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Analysis Time:</span>
                            <span class="result-value">${new Date().toLocaleString()}</span>
                        </div>
                        ${data.report_file ? `<a href="/api/view_report?path=${encodeURIComponent(data.report_file)}" class="report-link" target="_blank">📄 View Detailed Report</a>` : ''}
                    `;
                }
                
                results.style.display = 'block';
            } catch (error) {
                results.innerHTML = `<div class="error">Error running analysis: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        async function runJobMarketSentiment() {
            const button = document.querySelector('#job-sentiment-card .run-button');
            const loading = document.getElementById('sentimentLoading');
            const results = document.getElementById('sentimentResults');
            
            button.disabled = true;
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_job_market_sentiment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    document.getElementById('overallSentiment').textContent = data.summary.overall_sentiment;
                    document.getElementById('opportunityRatio').textContent = data.summary.opportunity_threat_ratio;
                    document.getElementById('dominantNarrative').textContent = data.summary.dominant_narrative;
                    document.getElementById('topSkill').textContent = data.summary.top_skill;
                    document.getElementById('employerSentiment').textContent = data.summary.employer_sentiment;
                    document.getElementById('employeeSentiment').textContent = data.summary.employee_sentiment;
                    
                    // Set report link
                    const reportPath = data.report_file.replace(/\\/g, '/');
                    document.getElementById('sentimentReportLink').href = `/api/view_report?path=${encodeURIComponent(reportPath)}`;
                    
                    results.style.display = 'block';
                } else {
                    alert('Sentiment analysis failed: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error running sentiment analysis: ' + error.message);
            } finally {
                loading.style.display = 'none';
                button.disabled = false;
            }
        }
        
        async function runAIAdoptionPredictions() {
            const button = document.querySelector('#ai-adoption-card .run-button');
            const loading = document.getElementById('adoptionLoading');
            const results = document.getElementById('adoptionResults');
            
            button.disabled = true;
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_ai_adoption_predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results using the metrics from the API response
                    document.getElementById('adoptionAnalyzed').textContent = data.metrics?.total_analyzed || 'N/A';
                    document.getElementById('adoptionPhase').textContent = data.metrics?.adoption_phase || 'N/A';
                    document.getElementById('transformationSpeed').textContent = data.metrics?.transformation_speed || 'N/A';
                    document.getElementById('topSkills').textContent = data.metrics?.top_skills || 'N/A';
                    
                    // Populate completed features
                    const featuresContainer = document.getElementById('completedFeatures');
                    featuresContainer.innerHTML = '';
                    if (data.features) {
                        data.features.forEach(feature => {
                            const li = document.createElement('li');
                            li.textContent = feature;
                            featuresContainer.appendChild(li);
                        });
                    }
                    
                    // Set report link
                    const reportPath = data.report_file.replace(/\\/g, '/');
                    document.getElementById('adoptionReportLink').href = `/api/view_report?path=${encodeURIComponent(reportPath)}`;
                    
                    results.style.display = 'block';
                } else {
                    alert('Predictions analysis failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error running predictions analysis: ' + error.message);
            } finally {
                loading.style.display = 'none';
                button.disabled = false;
            }
        }
        
        // Comprehensive Category Narratives JavaScript Functions
        async function runComprehensiveCategoryNarratives() {
            const button = document.querySelector('#comprehensive-narratives-card .btn-primary');
            const results = document.getElementById('narrativesResults');
            
            button.disabled = true;
            button.innerHTML = '⏳ Generating...';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run_comprehensive_category_narratives', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    // Update metrics
                    document.getElementById('narrativesCategoriesAnalyzed').textContent = data.metrics?.categories_analyzed || '-';
                    document.getElementById('narrativesTotalArticles').textContent = data.metrics?.total_articles || '-';
                    document.getElementById('narrativesAvgPerCategory').textContent = data.metrics?.avg_articles_per_category || '-';
                    
                    // Show results
                    results.style.display = 'block';
                    
                    // Update report link if available
                    if (data.report_file) {
                        const reportLink = document.getElementById('narrativesReportLink');
                        reportLink.href = `/api/download_report?file=${encodeURIComponent(data.report_file)}`;
                        reportLink.style.display = 'inline';
                    }
                    
                    alert('Comprehensive category narratives analysis completed successfully!');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = '🚀 Generate Narratives';
            }
        }
        
        async function showCategoryNarratives() {
            const modal = document.getElementById('narrativesModal');
            modal.style.display = 'block';
            
            // Load the replace narrative by default
            await loadCategoryNarrative('replace');
        }
        
        function closeNarrativesModal() {
            document.getElementById('narrativesModal').style.display = 'none';
        }
        
        async function showNarrativeTab(category) {
            // Update tab buttons
            document.querySelectorAll('#narrativesModal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('#narrativesModal .visualization-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${category}Tab`).classList.add('active');
            
            // Load narrative content
            await loadCategoryNarrative(category);
        }
        
        async function loadCategoryNarrative(category) {
            const narrativeDiv = document.getElementById(`${category}Narrative`);
            narrativeDiv.innerHTML = '⏳ Loading narrative...';
            
            try {
                const response = await fetch(`/api/category_narrative/${category}`);
                const data = await response.json();
                
                if (data.success && data.report) {
                    const report = data.report;
                    
                    // Format the narrative content
                    let html = `
                        <div class="narrative-content">
                            <div class="narrative-summary">
                                ${report.narrative_summary.replace(/\n/g, '<br>')}
                            </div>
                            
                            <div class="narrative-stats">
                                <div class="stat-item">
                                    <strong>Total Articles:</strong> ${report.total_articles_analyzed}
                                </div>
                                <div class="stat-item">
                                    <strong>High Confidence:</strong> ${report.high_confidence_articles}
                                </div>
                                <div class="stat-item">
                                    <strong>Average Confidence:</strong> ${report.avg_confidence.toFixed(3)}
                                </div>
                            </div>
                            
                            <div class="jobs-tasks-section">
                                <h4>🎯 Key Jobs and Tasks</h4>
                    `;
                    
                    // Add top jobs/tasks
                    const sortedJobs = Object.entries(report.jobs_and_tasks)
                        .sort(([,a], [,b]) => b.avg_confidence - a.avg_confidence)
                        .slice(0, 5);
                    
                    for (const [job, data] of sortedJobs) {
                        if (data.evidence_count >= 2) {
                            html += `
                                <div class="job-item">
                                    <div class="job-title">${job.toUpperCase().replace(/_/g, ' ')}</div>
                                    <div class="job-confidence">Confidence: ${data.avg_confidence.toFixed(3)}</div>
                                    <div class="job-evidence">Evidence: ${data.evidence_count} articles</div>
                                    <div class="job-citations">
                                        Top Citations:
                                        <ul>
                            `;
                            
                            for (const citation of data.citations.slice(0, 2)) {
                                html += `
                                    <li>
                                        <strong>${citation.title}</strong><br>
                                        <small>Confidence: ${citation.confidence.toFixed(3)} | Quality: ${citation.quality.toFixed(3)}</small><br>
                                        <small>Evidence: ${citation.evidence.slice(0, 3).join(', ')}</small>
                                    </li>
                                `;
                            }
                            
                            html += `
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                            </div>
                            
                            <div class="top-articles-section">
                                <h4>📚 Top Supporting Articles</h4>
                    `;
                    
                    // Add top articles
                    for (const [index, article] of report.top_articles.slice(0, 3).entries()) {
                        html += `
                            <div class="article-item">
                                <div class="article-title">${index + 1}. ${article.title}</div>
                                <div class="article-metrics">
                                    Confidence: ${article.confidence.toFixed(3)} | Quality: ${article.quality_score.toFixed(3)}
                                </div>
                                <div class="article-evidence">Evidence: ${article.evidence.slice(0, 3).join(', ')}</div>
                                ${article.key_insights.length > 0 ? `<div class="article-insight">Key Insight: ${article.key_insights[0].substring(0, 150)}...</div>` : ''}
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    narrativeDiv.innerHTML = html;
                } else {
                    narrativeDiv.innerHTML = `<div class="error">Failed to load narrative: ${data.message}</div>`;
                }
            } catch (error) {
                narrativeDiv.innerHTML = `<div class="error">Error loading narrative: ${error.message}</div>`;
            }
        }
        
        // Category Distribution Insights JavaScript Functions
        function runCategoryDistributionInsights() {
            const resultsDiv = document.getElementById('categoryDistributionResults');
            const button = event.target;
            
            // Show loading state
            button.innerHTML = '⏳ Analyzing...';
            button.disabled = true;
            resultsDiv.style.display = 'block';
            
            fetch('/api/run_category_distribution_insights', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update metrics
                    document.getElementById('categoryArticlesAnalyzed').textContent = data.metrics?.total_analyzed || 'N/A';
                    document.getElementById('categoryBalanceScore').textContent = data.metrics?.distribution_balance || 'N/A';
                    document.getElementById('categoryPredictionConfidence').textContent = 'High'; // From enhanced analysis
                    
                    // Update global metrics
                    document.getElementById('categoryDistributionCategories').textContent = data.metrics?.categories_covered || '5';
                    document.getElementById('categoryDistributionBalance').textContent = data.metrics?.distribution_balance || '0.70';
                    
                    // Set report link
                    const reportLink = document.getElementById('categoryDistributionReportLink');
                    if (data.report_file) {
                        reportLink.href = '/api/view_report?path=' + encodeURIComponent(data.report_file);
                    }
                    
                    // Load visualization data for interactive charts
                    loadCategoryVisualizationData();
                    
                } else {
                    alert('Analysis failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Analysis failed: ' + error.message);
            })
            .finally(() => {
                button.innerHTML = '🚀 Run Advanced Analysis';
                button.disabled = false;
            });
        }
        
        function showCategoryVisualization() {
            const modal = document.getElementById('categoryVisualizationModal');
            modal.style.display = 'block';
            
            // Initialize charts if not already done
            setTimeout(() => {
                initializeCategoryCharts();
            }, 100);
        }
        
        function closeCategoryVisualization() {
            const modal = document.getElementById('categoryVisualizationModal');
            modal.style.display = 'none';
        }
        
        function showVisualizationTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.visualization-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Hide all tab buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Activate tab button
            event.target.classList.add('active');
            
            // Initialize specific chart
            setTimeout(() => {
                initializeSpecificChart(tabName);
            }, 100);
        }
        
        function loadCategoryVisualizationData() {
            // This would typically fetch visualization data from the backend
            // For now, we'll use sample data
            window.categoryVisualizationData = {
                distribution: {
                    labels: ['Human Only', 'New Tasks', 'Replace', 'Augment', 'Unknown'],
                    data: [29.4, 21.5, 17.5, 9.0, 22.6],
                    colors: ['#96CEB4', '#45B7D1', '#FF6B6B', '#4ECDC4', '#FFEAA7']
                },
                evolution: {
                    months: ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'],
                    series: {
                        'Human Only': [28, 29, 30, 29, 30, 29],
                        'New Tasks': [20, 21, 22, 21, 22, 22],
                        'Replace': [18, 18, 17, 18, 17, 17],
                        'Augment': [9, 9, 8, 9, 9, 9]
                    }
                },
                predictions: {
                    current: [29.4, 21.5, 17.5, 9.0],
                    predicted: [31.2, 23.1, 16.8, 10.5],
                    confidence: [0.85, 0.78, 0.82, 0.75]
                }
            };
        }
        
        function initializeCategoryCharts() {
            initializeSpecificChart('distribution');
        }
        
        function initializeSpecificChart(chartType) {
            const data = window.categoryVisualizationData;
            if (!data) {
                loadCategoryVisualizationData();
                return;
            }
            
            switch(chartType) {
                case 'distribution':
                    initializeDistributionChart();
                    break;
                case 'evolution':
                    initializeEvolutionChart();
                    break;
                case 'network':
                    initializeNetworkChart();
                    break;
                case 'predictions':
                    initializePredictionsChart();
                    break;
            }
        }
        
        function initializeDistributionChart() {
            const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            const data = window.categoryVisualizationData?.distribution;
            
            if (window.categoryDistributionChartInstance) {
                window.categoryDistributionChartInstance.destroy();
            }
            
            window.categoryDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data?.labels || ['Human Only', 'New Tasks', 'Replace', 'Augment', 'Unknown'],
                    datasets: [{
                        data: data?.data || [29.4, 21.5, 17.5, 9.0, 22.6],
                        backgroundColor: data?.colors || ['#96CEB4', '#45B7D1', '#FF6B6B', '#4ECDC4', '#FFEAA7'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'AI Impact Category Distribution (%)',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        function initializeEvolutionChart() {
            const ctx = document.getElementById('categoryEvolutionChart').getContext('2d');
            const data = window.categoryVisualizationData?.evolution;
            
            if (window.categoryEvolutionChartInstance) {
                window.categoryEvolutionChartInstance.destroy();
            }
            
            const datasets = [];
            const colors = ['#96CEB4', '#45B7D1', '#FF6B6B', '#4ECDC4'];
            let colorIndex = 0;
            
            for (const [category, values] of Object.entries(data?.series || {})) {
                datasets.push({
                    label: category,
                    data: values,
                    borderColor: colors[colorIndex],
                    backgroundColor: colors[colorIndex] + '20',
                    tension: 0.4,
                    fill: false
                });
                colorIndex++;
            }
            
            window.categoryEvolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data?.months || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Category Evolution Over Time (%)',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage of Articles'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeNetworkChart() {
            const container = document.getElementById('categoryNetworkChart');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🔗</div>
                    <h4>Category Relationship Network</h4>
                    <p>Interactive network visualization showing relationships between AI impact categories</p>
                    <div style="margin: 20px 0;">
                        <div style="display: inline-block; margin: 5px; padding: 10px 15px; background: #96CEB4; color: white; border-radius: 20px;">Human Only</div>
                        <div style="display: inline-block; margin: 5px; padding: 10px 15px; background: #45B7D1; color: white; border-radius: 20px;">New Tasks</div>
                        <div style="display: inline-block; margin: 5px; padding: 10px 15px; background: #FF6B6B; color: white; border-radius: 20px;">Replace</div>
                        <div style="display: inline-block; margin: 5px; padding: 10px 15px; background: #4ECDC4; color: white; border-radius: 20px;">Augment</div>
                    </div>
                    <p><small>Advanced D3.js network visualization coming soon!</small></p>
                </div>
            `;
        }
        
        function initializePredictionsChart() {
            const ctx = document.getElementById('categoryPredictionsChart').getContext('2d');
            const data = window.categoryVisualizationData?.predictions;
            
            if (window.categoryPredictionsChartInstance) {
                window.categoryPredictionsChartInstance.destroy();
            }
            
            window.categoryPredictionsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Human Only', 'New Tasks', 'Replace', 'Augment'],
                    datasets: [{
                        label: 'Current',
                        data: data?.current || [29.4, 21.5, 17.5, 9.0],
                        backgroundColor: '#4ECDC4',
                        borderWidth: 2
                    }, {
                        label: 'Predicted (3 months)',
                        data: data?.predicted || [31.2, 23.1, 16.8, 10.5],
                        backgroundColor: '#FF6B6B',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Current vs Predicted Category Distribution (%)' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Percentage' }
                        }
                    }
                }
            });
        }
        
        // Main Visualization Functions
        let currentVizType = null;
        let vizCharts = {};
        
        function openVisualization(type) {
            currentVizType = type;
            const modal = document.getElementById('vizModal');
            const title = document.getElementById('vizModalTitle');
            
            // Set title based on analysis type
            const titles = {
                quality: '📈 Quality Distribution Visualizations',
                monitoring: '🔍 Collection Monitoring Visualizations',
                trends: '📊 Trend Analysis Visualizations',
                sentiment: '🎯 Job Market Sentiment Visualizations',
                adoption: '🚀 AI Adoption Predictions Visualizations'
            };
            
            title.textContent = titles[type] || 'Interactive Visualizations';
            modal.style.display = 'block';
            
            // Load data and initialize charts
            loadVisualizationData(type);
        }
        
        function closeVisualization() {
            const modal = document.getElementById('vizModal');
            modal.style.display = 'none';
            
            // Destroy existing charts to prevent memory leaks
            Object.values(vizCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            vizCharts = {};
        }
        
        function switchVizTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.viz-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.viz-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById('viz' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // Initialize chart for this tab if not already done
            if (!vizCharts[tabName]) {
                setTimeout(() => initializeChart(tabName), 100);
            }
        }
        
        async function loadVisualizationData(type) {
            try {
                const response = await fetch(`/api/visualization_data/${type}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading visualization data:', data.error);
                    return;
                }
                
                // Store data globally for chart initialization
                window.vizData = data;
                
                // Initialize the first chart (overview)
                setTimeout(() => initializeChart('overview'), 100);
                
            } catch (error) {
                console.error('Error fetching visualization data:', error);
                
                // Use mock data for demonstration
                window.vizData = generateMockData(type);
                setTimeout(() => initializeChart('overview'), 100);
            }
        }
        
        function initializeChart(chartType) {
            const canvasId = chartType + 'Chart';
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (vizCharts[chartType]) {
                vizCharts[chartType].destroy();
            }
            
            // Create new chart based on type and current analysis
            vizCharts[chartType] = createChart(ctx, chartType, currentVizType);
        }
        
        function createChart(ctx, chartType, analysisType) {
            const data = window.vizData || {};
            
            switch (chartType) {
                case 'overview':
                    return createOverviewChart(ctx, data, analysisType);
                case 'trends':
                    return createTrendsChart(ctx, data, analysisType);
                case 'relationships':
                    return createRelationshipsChart(ctx, data, analysisType);
                case 'predictions':
                    return createPredictionsChart(ctx, data, analysisType);
                default:
                    return null;
            }
        }
        
        function createOverviewChart(ctx, data, analysisType) {
            const chartConfigs = {
                quality: {
                    type: 'doughnut',
                    data: {
                        labels: ['Excellent', 'Good', 'Fair', 'Poor'],
                        datasets: [{
                            data: data.quality_distribution || [45, 35, 15, 5],
                            backgroundColor: ['#27ae60', '#f39c12', '#e67e22', '#e74c3c'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Quality Distribution Overview' }
                        }
                    }
                },
                monitoring: {
                    type: 'line',
                    data: {
                        labels: data.time_labels || ['1h', '2h', '3h', '4h', '5h', '6h'],
                        datasets: [{
                            label: 'Collection Rate',
                            data: data.collection_rates || [1.2, 1.5, 1.8, 1.3, 1.6, 1.4],
                            borderColor: '#3498db',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Collection Performance Overview' }
                        }
                    }
                },
                trends: {
                    type: 'line',
                    data: {
                        labels: data.months || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Quality Trend',
                            data: data.quality_trend || [0.65, 0.68, 0.72, 0.74, 0.76, 0.78],
                            borderColor: '#9b59b6',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Quality Trends Overview' }
                        }
                    }
                },
                sentiment: {
                    type: 'bar',
                    data: {
                        labels: ['Positive', 'Neutral', 'Negative'],
                        datasets: [{
                            label: 'Sentiment Distribution',
                            data: data.sentiment_distribution || [64.2, 24.7, 11.1],
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Job Market Sentiment Overview' }
                        }
                    }
                },
                adoption: {
                    type: 'radar',
                    data: {
                        labels: ['Technical Skills', 'Human Skills', 'Hybrid Skills', 'AI Skills', 'Traditional Skills'],
                        datasets: [{
                            label: 'Skill Demand',
                            data: data.skill_demand || [85, 75, 90, 95, 60],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'AI Adoption Skills Overview' }
                        }
                    }
                }
            };
            
            const config = chartConfigs[analysisType] || chartConfigs.quality;
            return new Chart(ctx, config);
        }
        
        function createTrendsChart(ctx, data, analysisType) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.time_series?.labels || ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Trend Analysis',
                        data: data.time_series?.values || [20, 25, 30, 35],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: `${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Trends Analysis` }
                    }
                }
            });
        }
        
        function createRelationshipsChart(ctx, data, analysisType) {
            return new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Correlation Analysis',
                        data: data.correlations || [
                            {x: 0.8, y: 0.9}, {x: 0.6, y: 0.7}, 
                            {x: 0.4, y: 0.5}, {x: 0.9, y: 0.8}
                        ],
                        backgroundColor: '#e74c3c'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Relationships & Correlations' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Factor A' } },
                        y: { title: { display: true, text: 'Factor B' } }
                    }
                }
            });
        }
        
        function createPredictionsChart(ctx, data, analysisType) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.prediction_labels || ['Next Month', '3 Months', '6 Months', '1 Year'],
                    datasets: [{
                        label: 'Predictions',
                        data: data.predictions || [75, 80, 85, 90],
                        backgroundColor: '#9b59b6'
                    }, {
                        label: 'Confidence Interval',
                        data: data.confidence || [70, 75, 80, 85],
                        backgroundColor: 'rgba(155, 89, 182, 0.3)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Predictive Analytics' }
                    }
                }
            });
        }
        
        function generateMockData(type) {
            // Generate appropriate mock data based on analysis type
            const mockData = {
                quality: {
                    quality_distribution: [47, 35, 15, 3],
                    time_series: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        values: [0.65, 0.68, 0.72, 0.74, 0.76, 0.78]
                    }
                },
                monitoring: {
                    collection_rates: [1.2, 1.5, 1.8, 1.3, 1.6, 1.4],
                    time_labels: ['1h ago', '2h ago', '3h ago', '4h ago', '5h ago', '6h ago']
                },
                trends: {
                    quality_trend: [0.65, 0.68, 0.72, 0.74, 0.76, 0.78],
                    months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']
                },
                sentiment: {
                    sentiment_distribution: [64.2, 24.7, 11.1]
                },
                adoption: {
                    skill_demand: [85, 75, 90, 95, 60]
                }
            };
            
            return mockData[type] || mockData.quality;
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('vizModal');
            if (event.target === modal) {
                closeVisualization();
            }
        }
        
        // Add some visual feedback on page load
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.analysis-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    card.style.transition = 'all 0.6s ease';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });
        });
    </script>
    </div>
{% endblock %}
